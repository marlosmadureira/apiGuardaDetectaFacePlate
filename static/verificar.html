<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Guarda – Verificação de Acesso</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0;
      padding: 20px;
      background: #0f0f14;
      color: #c0caf5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    h1 { color: #7aa2f7; font-size: 1.4rem; margin-bottom: 8px; }
    .sub { color: #565f89; font-size: 0.9rem; margin-bottom: 20px; }
    .camera-wrap {
      position: relative;
      background: #000;
      border-radius: 16px;
      overflow: hidden;
      width: 100%;
      max-width: 720px;
      aspect-ratio: 4/3;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    #canvas { display: none; }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    .status-overlay {
      z-index: 2;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    .status-box {
      padding: 24px 48px;
      border-radius: 16px;
      font-size: 1.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      text-shadow: 0 2px 8px rgba(0,0,0,0.8);
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(8px);
    }
    .status-box.autorizado {
      color: #9ece6a;
      border: 3px solid #9ece6a;
    }
    .status-box.autorizado-placa {
      color: #bb9af7;
      border: 3px solid #bb9af7;
    }
    .status-box.nao-autorizado {
      color: #f7768e;
      border: 3px solid #f7768e;
    }
    .status-box.verificando {
      color: #7aa2f7;
      border: 3px solid #7aa2f7;
      font-size: 1.2rem;
    }
    .person-name { font-size: 1rem; margin-top: 8px; text-transform: none; letter-spacing: 0; opacity: 0.95; }
    .detail-line { font-size: 0.85rem; margin-top: 4px; opacity: 0.9; }
    .controls {
      margin-top: 20px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: #414868;
      color: #c0caf5;
    }
    button:hover { opacity: 0.9; }
    button.primary { background: #7aa2f7; color: #1a1b26; }
    button.danger { background: #f7768e; color: #1a1b26; }
    a { color: #7aa2f7; }
    .hint { color: #565f89; font-size: 0.85rem; margin-top: 16px; text-align: center; max-width: 480px; }
    #chromeHint { display: none; color: #f7768e; font-size: 0.85rem; margin-bottom: 12px; background: #2d202a; padding: 10px; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>Guarda – Verificação de Acesso</h1>
  <p class="sub">Câmera ao vivo: o mesmo frame é usado para <strong>reconhecimento facial</strong> e <strong>leitura de placa</strong>. Libera por rosto (pedestre), por placa (veículo) ou por ambos.</p>
  <p id="chromeHint">No Chrome use <a href="http://localhost:8000/verificar">http://localhost:8000/verificar</a> (não 0.0.0.0:8000).</p>

  <div class="camera-wrap">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
    <div class="status-overlay">
      <div id="statusBox" class="status-box verificando">Iniciando...</div>
    </div>
  </div>
  <canvas id="canvas"></canvas>

  <div class="controls">
    <button type="button" class="primary" id="btnStart">Iniciar câmera</button>
    <button type="button" id="btnStop" style="display:none;">Parar</button>
  </div>
  <p class="hint">A verificação é feita a cada 2 segundos. Quando um rosto é detectado, são exibidos os <strong>pontos de reconhecimento</strong>: contorno do queixo, olhos, nariz, sobrancelhas e boca (linhas e pontos coloridos). O retângulo verde marca o rosto; o azul marca a placa.</p>
  <p class="hint"><a href="/">Cadastro de rosto</a> · <a href="/placas">Cadastro de placas</a> · <a href="/autorizacoes">Autorizações</a></p>

  <script>
    var API_BASE = '';
    var stream = null;
    var intervalId = null;
    var isChecking = false;

    var video = document.getElementById('video');
    var canvas = document.getElementById('canvas');
    var overlay = document.getElementById('overlay');
    var statusBox = document.getElementById('statusBox');

    function drawBoxes(faceBbox, plateBbox, faceLandmarks) {
      if (!overlay || !video.videoWidth) return;
      var vw = video.videoWidth;
      var vh = video.videoHeight;
      var cw = video.clientWidth;
      var ch = video.clientHeight;
      var scale = Math.max(cw / vw, ch / vh);
      var offsetX = (cw - vw * scale) / 2;
      var offsetY = (ch - vh * scale) / 2;
      function toDisplayXY(x, y) {
        return [ offsetX + x * scale, offsetY + y * scale ];
      }
      function toDisplay(bbox) {
        if (!bbox || bbox.length !== 4) return null;
        var x = bbox[0], y = bbox[1], w = bbox[2], h = bbox[3];
        return [ offsetX + x * scale, offsetY + y * scale, w * scale, h * scale ];
      }
      overlay.width = cw;
      overlay.height = ch;
      var ctx = overlay.getContext('2d');
      ctx.clearRect(0, 0, cw, ch);

      if (faceLandmarks && typeof faceLandmarks === 'object') {
        var colors = {
          chin: '#9ece6a',
          left_eyebrow: '#b4f1b4',
          right_eyebrow: '#b4f1b4',
          nose_bridge: '#7dcfff',
          nose_tip: '#7dcfff',
          left_eye: '#f9e2af',
          right_eye: '#f9e2af',
          top_lip: '#f7768e',
          bottom_lip: '#f7768e'
        };
        Object.keys(faceLandmarks).forEach(function(key) {
          var pts = faceLandmarks[key];
          if (!pts || pts.length < 2) return;
          var d = toDisplayXY(pts[0][0], pts[0][1]);
          ctx.strokeStyle = colors[key] || '#9ece6a';
          ctx.fillStyle = colors[key] || '#9ece6a';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(d[0], d[1]);
          for (var i = 1; i < pts.length; i++) {
            d = toDisplayXY(pts[i][0], pts[i][1]);
            ctx.lineTo(d[0], d[1]);
          }
          if (key === 'chin' || key === 'top_lip' || key === 'bottom_lip') ctx.closePath();
          ctx.stroke();
          pts.forEach(function(p) {
            var d = toDisplayXY(p[0], p[1]);
            ctx.beginPath();
            ctx.arc(d[0], d[1], 2.5, 0, Math.PI * 2);
            ctx.fill();
          });
        });
      }

      var faceRect = toDisplay(faceBbox);
      if (faceRect) {
        ctx.strokeStyle = '#9ece6a';
        ctx.lineWidth = 3;
        ctx.strokeRect(faceRect[0], faceRect[1], faceRect[2], faceRect[3]);
        ctx.font = '14px sans-serif';
        ctx.fillStyle = '#9ece6a';
        ctx.fillText('Rosto', faceRect[0], faceRect[1] - 4);
      }
      var plateRect = toDisplay(plateBbox);
      if (plateRect) {
        ctx.strokeStyle = '#7aa2f7';
        ctx.lineWidth = 3;
        ctx.strokeRect(plateRect[0], plateRect[1], plateRect[2], plateRect[3]);
        ctx.font = '14px sans-serif';
        ctx.fillStyle = '#7aa2f7';
        ctx.fillText('Placa', plateRect[0], plateRect[1] - 4);
      }
    }

    function clearOverlay() {
      if (!overlay || !video) return;
      overlay.width = video.clientWidth;
      overlay.height = video.clientHeight;
      var ctx = overlay.getContext('2d');
      ctx.clearRect(0, 0, overlay.width, overlay.height);
    }

    function getUserMediaPromise(constraints) {
      if (navigator.mediaDevices && typeof navigator.mediaDevices.getUserMedia === 'function')
        return navigator.mediaDevices.getUserMedia(constraints);
      var fn = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
      if (!fn) return Promise.reject(new Error('Câmera não disponível'));
      return new Promise(function(ok, err) { fn.call(navigator, constraints, ok, err); });
    }

    function setStatus(klass, text, sub) {
      statusBox.className = 'status-box ' + klass;
      statusBox.innerHTML = text + (sub ? '<div class="person-name">' + sub + '</div>' : '');
    }

    function buildDetail(data, autorizadoPor) {
      if (autorizadoPor === 'autorizado') return data.person_name ? 'Rosto: ' + data.person_name : '';
      if (autorizadoPor === 'autorizado-placa') return data.vehicle_plate ? 'Placa: ' + data.vehicle_plate : '';
      var parts = [];
      if (data.person_name) parts.push('Rosto: ' + data.person_name);
      if (data.vehicle_plate) parts.push('Placa: ' + data.vehicle_plate);
      if (parts.length === 0) parts.push('Nenhum reconhecido');
      return parts.join(' · ');
    }

    function checkFace() {
      if (!stream || isChecking || !video.videoWidth) return;
      isChecking = true;
      setStatus('verificando', 'Verificando...', '');
      clearOverlay();
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      var ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      canvas.toBlob(function(blob) {
        if (!blob) { isChecking = false; setStatus('nao-autorizado', 'Erro', 'Sem imagem'); return; }
        var form = new FormData();
        form.append('face_image', blob, 'frame.jpg');
        fetch(API_BASE + '/access/check', { method: 'POST', body: form })
          .then(function(r) { return r.json(); })
          .then(function(data) {
            drawBoxes(data.face_bbox || null, data.plate_bbox || null, data.face_landmarks || null);
            if (data.allowed) {
              var autorizadoPor = data.person_name ? 'autorizado' : (data.vehicle_plate ? 'autorizado-placa' : 'autorizado');
              var detail = buildDetail(data, autorizadoPor);
              setStatus(autorizadoPor, 'Autorizado', detail);
            } else {
              var detail = buildDetail(data, null);
              setStatus('nao-autorizado', 'Não autorizado', data.message || detail);
            }
          })
          .catch(function(e) {
            setStatus('nao-autorizado', 'Erro', e.message || 'Sem resposta');
          })
          .finally(function() { isChecking = false; });
      }, 'image/jpeg', 0.85);
    }

    document.getElementById('btnStart').addEventListener('click', function() {
      setStatus('verificando', 'Abrindo câmera...', '');
      getUserMediaPromise({ video: { facingMode: 'user', width: 640, height: 480 } })
        .then(function(s) {
          stream = s;
          video.srcObject = stream;
          setStatus('verificando', 'Verificando...', 'Aguardando rosto');
          document.getElementById('btnStart').style.display = 'none';
          document.getElementById('btnStop').style.display = 'inline-block';
          intervalId = setInterval(checkFace, 2000);
        })
        .catch(function(e) {
          setStatus('nao-autorizado', 'Erro câmera', e.message || '');
          var h = document.getElementById('chromeHint');
          if (h) h.style.display = 'block';
        });
    });

    document.getElementById('btnStop').addEventListener('click', function() {
      if (intervalId) { clearInterval(intervalId); intervalId = null; }
      if (stream) { stream.getTracks().forEach(function(t) { t.stop(); }); stream = null; }
      video.srcObject = null;
      setStatus('verificando', 'Iniciando...', '');
      document.getElementById('btnStart').style.display = 'inline-block';
      document.getElementById('btnStop').style.display = 'none';
    });

    if (location.hostname === '0.0.0.0') {
      var h = document.getElementById('chromeHint');
      if (h) h.style.display = 'block';
    }
  </script>
</body>
</html>
